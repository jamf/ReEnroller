<html>
<head>
<meta charset="utf-8">
<title>ReEnroller Help</title>
<meta name="generator" content="lnh">
<style>
body
{
   background-color: #D6DBDB;
   color: #000000;
   font-family: Arial;
   font-weight: normal;
   font-size: 13px;
   line-height: 1.1875;
   margin: 0;
   padding: 0;
}
a
{
   color: #0000FF;
   text-decoration: underline;
}
a:visited
{
   color: #800080;
}
a:active
{
   color: #FF0000;
}
a:hover
{
   color: #0000FF;
   text-decoration: underline;
}
#wb_Heading1
{
   background-color: #FFFFFF;
   background-image: none;
   border: 0px #000000 solid;
   padding: 0px 0px 0px 0px;
}
#Heading1
{
   color: #000000;
   font-family: Arial;
   font-weight: normal;
   font-size: 32px;
   margin: 0;
   text-align: center;
}
#wb_Text1
{
   background-color: transparent;
   background-image: none;
   border: 0px #C0C0C0 solid;
   padding: 0;
   margin: 0;
   text-align: left;
}
#main_body div
{
    text-align: left;
    padding: 10px 20px 10px 20px;
}
#wb_Text1 div
{
   text-align: left;
}
#wb_Text2
{
   background-color: transparent;
   background-image: none;
   border: 0px #C0C0C0 solid;
   padding: 0;
   margin: 0;
   text-align: left;
}
#wb_Text2 div
{
   text-align: left;
}
#appImage img
{
    border: 0px #000000 solid;
    padding: 10px 0px 10px 50px;
    margin: auto;
    width:490px;
    position: relative
}
#appImage2 img
{
    border: 0px #000000 solid;
    padding: 10px 0px 10px 50px;
    margin: auto;
    width:400px;
    position: relative
}
#appImage3 img
{
    border: 0px #000000 solid;
    padding: 10px 0px 10px 50px;
    margin: auto;
    width:220px;
    position: relative
}
#jpsImage img
{
    border: 0px #000000 solid;
    padding: 10px 0px 10px 50px;
    margin: auto;
    width:494px;
    position: relative
}
#jpsImage2 img
{
    border: 0px #000000 solid;
    padding: 10px 0px 10px 50px;
    margin: auto;
    width:640px;
    position: relative
}
#wb_Text3
{
   background-color: transparent;
   background-image: none;
   border: 0px #C0C0C0 solid;
   padding: 0;
   margin: 0;
   text-align: left;
}
#wb_Text3 div
{
   text-align: left;
}
#Image3
{
   border: 0px #000000 solid;
   padding: 0px 0px 0px 0px;
   left: 0;
   top: 0;
   width: 100%;
   height: 100%;
}
</style>
</head>
<body>
<div id="Heading1" style="position:relative;text-align: center;">
<h1 id="Heading1">ReEnroller</h1></div>
<div id="main_body" style="position:relative;">
<div style="font-family:Arial;font-size:13px;line-height:15px;color:#000000;">
    <div>Use the ReEnroller app to generate a custom Quickadd package for your clients to (re)enroll the Mac.  Packages can be created to help migrate from one server to another or perform an initial enrollment.  The process, if successful, will enroll the machine into the new Jamf Pro server so that policies can be run.  Note, a valid (trusted) certificate used to encrypt traffic to the destination Jamf Pro server is requird.  To enable MDM functionality additional steps are required.</div>
    <div><strong>Important:</strong> If deploying the package to macOS 13+ be sure to deploy the ReEnrollerNotification.mobileconf before deploying the package to suppress unwanted notifications.</div>
<ul style="margin-left:17px;line-height: 1.4;">
    <li>Enter the URL and Jamf administrator credentials, or an account with at least enrollment privileges, for the new Jamf server.</li>
    <li>The server must have a trusted certificate used to encrypt https traffic.</li>
    <li>In the event network connectivity gets disrupted during the migration, connectivity is dependent on a configuration profile that gets removed, wifi imformation can be suplied to maintain a connection. Note, the connection only supports WPA.</li>
    <li>Be sure you're familiar with the usage/configuration of a (local) management account. Reference: <a href="https://learn.jamf.com/en-US/bundle/jamf-pro-documentation-current/page/Management_Accounts.html" target="_blank">Local Management Accounts</a></li>
    <li>If you wish to retain the existing management account and the password enter those credentials.&nbsp; If you wish to change the management account and or password, or wish to use a random password a new management account must be entered.&nbsp; This must be an account not currently on the machine, it will be created during (re)enrollment.&nbsp;&nbsp; </li>
    <li>If you wish to generate a package for an initial enrollment check 'Use for new enrollment'.</li>
    <li>Select appropriate Site options.&nbsp; If the computer account already exists on the destination server with a Site assignemt, the Site may be preserved during re-enrollment.&nbsp; You're also able to select the Site to migrate the system into.</li>
    <li>To automatically create the policy used on the destination server to verity enrollment check the 'Create Migration Complete policy' box.</li>
    <li>If APNs is not being used on the destination server, or you wish to skip the APNs test for some other reason, check the box 'Skip MDM verification'.</li>
    <li>If you'd like to run a specific policy after migration has been verified and recon is complete select the option to do so.  Be sure to use the correct policy id from the policy on the destination server.</li>
    <li>If calling device enrollment be sure the devicd has been assigned to a prestage in the new environment.</li>
    <li>You can mark the machine as migrated by updating an attribute in the device record in the old server.</li>
    <li>Select when to remove the MDM profile installed by the source Jamf Pro server, or leave it on the machine to be removed later. If before, configure the apiMDM_remove script on the source (server you're migrating from) server. If after, configure the apiMDM_remove script on the destination (server you're migrating to) server. See the instructions below to ensure the script/policy is properly configured on the correct server.</li>
    <li>By default the package cleans up once migration is complete.&nbsp; If you'd like to keep things in place uncheck the box for removing the ReEnroller folder.</li>
    <li>If desired set the number of times the client will try the enrollment process in the event it fails for some reason.  Leaving the field blank will set the client to keep retrying until successful.</li>
    <li>Set an interval for the process to retry re-enrollment (5 minutes or greater) in the event it fails, or keep the default of 30 minutes.  You are able to separate the launch daemon/postinstall script from the re-enrollment application by checking the box, 'Create Separate Package'.  With the box checked 2 packages will be created, one with the launchdaemon and postinstall script, the other with the re-enrollment application and settings.  This allows one to stage the application then deploy the launch daemon at a later date, or create a custom launch daemon, say to repair enrollments that have failed over time.</li>
    </ul>
<div>Once everything is configured click Build.</div>
</div></div>
<div id="appImage">
<img src="images/ReEnroller.png" alt=""></div>
    <div id="main_body" style="position:relative;">
        <div style="font-family:Arial;font-size:13px;line-height:15px;color:#000000;">
            <div>To help track migrated machines, click 'Mark machine as migrated' and select the attribute to update.  If using Phone, Position, or Room, disable 'Collect user and location information from LDAP' from Computer Management --> Inventory Collection. Any existing data will be overwriten.</div>
        </div>
    </div>
<div id="appImage2">
    <img src="images/attribute.png" alt="">
</div>
    <div id="main_body" style="position:relative;">
        <div style="font-family:Arial;font-size:13px;line-height:15px;color:#000000;">
            <div>Control if/when the MDM profile is removed, either before or after enrollment in the new Jamf Server.  In addition you can leave the MDM profile in place and develop a workflow outside ReEnroller to remove it.</div>
        </div>
    </div>
<div id="appImage3">
    <img src="images/removeMDM.png" alt="">
</div>
<div id="main_body" style="position:relative;">
<div style="font-family:Arial;font-size:13px;line-height:15px;color:#000000;">
<div>After the process is complete you&rsquo;ll find a package, (Re)Enroller-&lt;hostname&gt;.pkg, saved to Downloads.&nbsp; If creating a second package, (Re)EnrollerDaemon-&lt;hostname&gt;.pkg, will also appear on Downloads.  Each package is ready to be deployed with a policy on the Jamf Server.</div>
</div></div>
<div id="main_body" style="position:relative;">
    <div style="font-family:Arial;font-size:13px;line-height:15px;color:#000000;">
<div>Once a package is built, and profiles are in place, it can be uploaded to the source Jamf Pro server for deployment.</div>
    </div>
<div id="main_body" style="position:relative;">
    <div style="font-family:Arial;font-size:13px;line-height:15px;color:#000000;">
    As the re-enrollment process kicks off the client will attempt to download, and use, the jamf binary from the new Jamf server.  If the download fails it will rely on the existing jamf binary.  Existing configurations will be backed up to /Library/Application Support/JAMF/ReEnroller/backup.  Upon successful re-enrollment the backups will be deleted, if the re-enrollment fails the backups will be restored.
<div><hr></div>
To verify the machine successfully migrated a 'Migration Complete' policy must exist on the new server, scoped to all managed clients.&nbsp; As mentioned earlier this policy may be created automatically.&nbsp; If you wish to create it manually it must, at a minimum, contain a Files and Processes payload.&nbsp; On the policy General tab configure a Custom Event (jpsmigrationcheck) and Execution Frequency (Ongoing) as illustrated below:
</div>
</div>
<div id="jpsImage">
<img src="images/general.png" alt=""></div>
<div id="main_body" style="position:relative;">
<div style="font-family:Arial;font-size:13px;line-height:15px;color:#000000;">
The Files and Processes payload must contain the following in the Execute Command section: <br><span style="font-family:'Courier New';">touch /Library/Application\ Support/JAMF/ReEnroller/Complete</span>
</div>
</div>
<div id="jpsImage">
<img src="images/executeCommand.png" alt=""></div>
<div id="main_body" style="position:relative;">
<div style="font-family:Arial;font-size:13px;line-height:15px;color:#000000;">
If utilizing a random password for the management account we also need a Management Account payload with (minimum) settings as shown:
</div>
</div>
<div id="jpsImage">
<img src="images/managementAccount.png" alt=""></div>
<div id="main_body" style="position:relative;">
<div style="font-family:Arial;font-size:13px;line-height:15px;color:#000000;"></div>
<div><hr></div>
    
<div><strong>Jamf School Migrations</strong></div>
<div id="jpsImage">
<img src="images/reEnrollerJamfSchool.png" alt=""></div>    
    
    
<div id="main_body" style="position:relative;">
<div style="font-family:Arial;font-size:13px;line-height:15px;color:#000000;">
Jamf School migrations require the following information from your Jamf School instance:
<ul style="margin-left:17px;line-height: 1.4;">
    <li>Jamf School URL</li>
    <li>Network ID.  Found under Devices → Enroll Devices(s)</li>
    <div id="jpsImage2">
<img src="images/jamfSchoolNetworkId.png" alt=""></div>  
    <li>An API key with Add permission.  Found under Organization → Settings → API</li>
    <div id="jpsImage2">
<img src="images/JamfSchoolApiKey.png" alt=""></div>  
    </ul>
</div>
</div> 
<div id="main_body" style="position:relative;">
<div style="font-family:Arial;font-size:13px;line-height:15px;color:#000000;">
As the ReEnroller package is built the following will be created on the destination Jamf Server, if they don’t exist, to perform unenrollment from Jamf School.
    <ul>
<li>Category - Name: Jamf School Unenroll</li>
<li>Script - Name: Jamf School Unenroll</li>
<li>Policy - Name: Jamf School Unenroll</li>
    </ul>
Note, these objects are not updated when new packages are built and must be deleted from Jamf Pro if say you change the API key.
<div><hr></div>    
    
<strong>High Sierra (10.13) and later:</strong>
<div id="main_body" style="position:relative;">
<div style="font-family:Arial;font-size:13px;line-height:15px;color:#000000;">
Starting with 10.13 Apple added /var/db/ConfigurationProfiles to SIP.  To ensure the MDM payload is removed additional setup is required, creating a script and policy for MDM removal.
    The following sample script can be used:
    <pre><span style="font-family:'Courier New';">
        <hr>
        <code>
            #!/bin/bash

            ##########################################################################################
            ##
            ##Copyright (c) 2017 Jamf.  All rights reserved.
            ##
            ##      Redistribution and use in source and binary forms, with or without
            ##      modification, are permitted provided that the following conditions are met:
            ##              * Redistributions of source code must retain the above copyright
            ##                notice, this list of conditions and the following disclaimer.
            ##              * Redistributions in binary form must reproduce the above copyright
            ##                notice, this list of conditions and the following disclaimer in the
            ##                documentation and#or other materials provided with the distribution.
            ##              * Neither the name of the Jamf nor the names of its contributors may be
            ##                used to endorse or promote products derived from this software without
            ##                specific prior written permission.
            ##
            ##      THIS SOFTWARE IS PROVIDED BY JAMF SOFTWARE, LLC "AS IS" AND ANY
            ##      EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
            ##      WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
            ##      DISCLAIMED. IN NO EVENT SHALL JAMF SOFTWARE, LLC BE LIABLE FOR ANY
            ##      DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
            ##      (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
            ##      LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
            ##      ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
            ##      (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
            ##      SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
            ##
            ##########################################################################################
            #
            # SUPPORT FOR THIS PROGRAM
            #
            #       This program is distributed "as is" by JAMF Software, Professional Services Team. For more
            #       information or support for this script, please contact your JAMF Software Account Manager.
            #
            #####################################################################################################
            #
            # ABOUT THIS PROGRAM
            #
            # NAME - apiMDM_remove.sh
            #
            # DESCRIPTION - Script is used to remove MDM from macOS clients 10.13 (High Sierra) and later.
            #               Parameters passed to the script include a Jamf server username and password and
            #               optionally the Jamf server URL in the form: https://FQDN:port/.
            #
            #               The jamf user aaccount must have at least computer create and read (JSS Objects)
            #               along with Send Computer Unmanage Command (JSS Actions).
            #
            ####################################################################################################
            #
            # HISTORY
            #
            #    Version: 1.5
            #
            #   - Created by Leslie Helou, Professional Services Engineer, JAMF Software on December 12, 2017
            #   - updated 20190124: Provide additional feedback as it runs
            #   - updated 20200918: Updates due to changes in xpath for Big Sur
            #   - updated 20240726: Update to use token for authentication
            #   - updated 20251020: Update for Jamf Pro 11.21 (removal of UnmanageDevice from Classic API)
            #
            ####################################################################################################


            invalidateToken() {
                response=$(curl -w "%{http_code}" -H "Authorization: Bearer $token" "${server}api/v1/auth/invalidate-token" -X POST -s -o /dev/null)
                if [[ $response == 204 ]]; then
                    echo "Token successfully invalidated"
                    exit 0
                elif [[ $response == 401 ]]; then
                    echo "Token already invalid"
                    exit 0
                else
                    echo "An unknown error occurred invalidating the token"
                    exit 1
                fi
            }

            ## check run settings for arguments

            ## get macOS version
            macOS_Version=$(sw_vers -productVersion)
            majorVer=$( /bin/echo "$macOS_Version" | /usr/bin/awk -F. '{print $1}' )
            minorVer=$( /bin/echo "$macOS_Version" | /usr/bin/awk -F. '{print $2}' )

            ## account with computer create and read (JSS Objects), Send Computer Unmanage Command (JSS Actions)
            uname="$4"
            pwd="$5"

            if [ "$uname" == "" ];then
                echo "missing client ID - exiting."
                exit 1
            fi

            if [ "$pwd" == "" ];then
                echo "missing client secret - exiting."
                exit 1
            fi

            if [ "$6" != "" ];then
                server="$6"
            else
                ## get current Jamf Pro server
                server=$(/usr/bin/defaults read /Library/Preferences/com.jamfsoftware.jamf.plist jss_url)
                echo "using server read from com.jamfsoftware.jamf.plist: ${server}"
            fi

            if [ "$server" == "" ];then
                echo "unable to determine current Jamf Pro server - exiting."
                exit 1
            fi

            ## ensure the server URL ends with a /
            strLen=$((${#server}-1))
            lastChar="${server:$strLen:1}"
            if [ ! "$lastChar" = "/" ];then
                server="${server}/"
            fi

            ## get unique identifier for machine
            udid=$(/usr/sbin/system_profiler SPHardwareDataType | awk '/UUID/ { print $3; }')
            if [ "$udid" == "" ];then
                echo "unable to determine UUID of computer - exiting."
                exit 1
            else
                echo "computer UUID: $udid"
            fi

            ## get token
            tokenURL="${server}api/oauth/token"

            clientString="grant_type=client_credentials&client_id=$uname&client_secret=$pwd"

            ## echo "getToken: curl -m 20 -s $tokenURL -X POST -H \"Content-Type: application/x-www-form-urlencoded\" -d \"$clientString\""

            response=$(curl -m 20 -s $tokenURL -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "$clientString")
            ## echo "response: $response"
            token=$(/usr/bin/osascript -l JavaScript << EoS
                ObjC.unwrap($response.access_token)
            EoS
            )
            ## echo "theToken: $token"

            ## get computer ID from Jamf server
            echo "get computer ID: curl -m 20 -s ${server}JSSResource/computers/udid/$udid/subset/general -H \"Accept: application/xml\" -H \"Authorization: Bearer $(echo $token | head -n15)...\""
            compXml=$(/usr/bin/curl -m 20 -s ${server}JSSResource/computers/udid/$udid/subset/general -H "Accept: application/xml" -H "Authorization: Bearer $token")
            ## echo "computer record: ${compXml}"

            if [[ $(echo "${compXml}" | grep "The server has not found anything matching the request URI") == "" ]];then
                if [ $majorVer -gt 10 ] || ([ $majorVer eq 10 ] && [ $majorMinor -gt 15 ]);then
                    compId=$(echo "${compXml}" | /usr/bin/xpath -q -e "//computer/general/id/text()")
                else
                    compId=$(echo "${compXml}" | /usr/bin/xpath "//computer/general/id/text()")
                fi
                echo "computer ID: $compId"
            else
                echo "computer was not found on $server - exiting."
                exit 1
            fi

            ## get Jamf Pro version
            version=$(/usr/bin/curl -m 20 -s ${server}api/v1/jamf-pro-version -X GET -H "Authorization: Bearer $token" | awk -F"\"" '{ print $4 }')
            echo "Running Jamf Pro $version"
            jpMajVer=$(echo $version | awk -F. {'print $1'})
            jpMinVer=$(echo $version | awk -F. {'print $2'})

            ## send unmanage command to machine
            if [ $jpMajVer -gt 10 ] && [ $jpMinVer -gt 20 ];then
                echo "unmanage machine: curl -m 20 -s ${server}api/v1/computer-inventory/${compId}/remove-mdm-profile -X POST -H \"Authorization: Bearer $(echo $token | head -n15)...\""
                /usr/bin/curl -m 20 -s ${server}api/v1/computer-inventory/${compId}/remove-mdm-profile -X POST -H "Authorization: Bearer $token"
            else
                echo "unmanage machine: curl -m 20 -s ${server}JSSResource/computercommands/command/UnmanageDevice/id/${compId} -X POST -H \"Authorization: Bearer $(echo $token | head -n15)...\""
                /usr/bin/curl -m 20 -s ${server}JSSResource/computercommands/command/UnmanageDevice/id/${compId} -X POST -H "Authorization: Bearer $token"
            fi
    
            echo
            invalidateToken
            </code>

<br><hr>
<?php
    copy("./apiMDM_remove.txt","/tmp/apiMDM_remove.txt");
    echo getcwd();
?>
</span></pre></div>
    Create a policy to deploy the script on the source server (server you are migrating from).  <b>The policy must have a custom trigger of apiMDM_remove</b>.  Also set the policy to Ongoing.
<div id="jpsImage2">
<img src="images/mdmRemove_general.png" alt=""></div>
    The script requires 2 parameters, a Jamf Pro API client and secret. If the MDM profile is to be removed prior to (before) enrolling in the new serve, add the script/policy to the Jamf Pro server that the machine is being unenrolled.<p>

    The account must have at least Computers Create and Read (Jamf Pro Server Objects) along with Send Computer Unmanage Command (Jamf Pro Server Actions). The account (API client) is always set up on the Jamf Pro server that the machine is being unenrolled.<p>
    
    A third parameter may be also be provided, the current Jamf server the client has received it's MDM profile from.  If the parameter is not provided the server will be read from com.jamfsoftware.jamf.plist.  <strong>If the MDM profile is removed after enrollment in the new server the Jamf URL parameter must be provided, the URL being the server the client was migrated from.  The script/policy must also be set up on the destination server.</strong>
<div id="jpsImage2">
<img src="images/mdmRemove_script.png" alt=""></div>
</div>
    The script could also be added to the policy that deploys the reEnrollment package, if you'd like the profile removed before the new enrollment. Be mindful that once the MDM profile is removed all other profiles will be removed, potentially impacting the user experience. 
<div><hr></div>
</div>
</body>
</html>
